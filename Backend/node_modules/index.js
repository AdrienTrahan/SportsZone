const express = require('express');
const bodyParser = require("body-parser");
const path = require("path");

const mongo = require('mongodb').MongoClient;
const ObjectID = require('mongodb').ObjectID;

let url = "mongodb://18.189.214.49:27017";
let mongodb = undefined;
mongo.connect(url, async function(err, client) {
    if (err) throw err;
    console.log("mongodb Connected...");
    mongodb = client.db("SportsZone");
    const credentials = require('./credentials/registration')(mongodb);
    const teamProfile = require('./teams/profile')(mongodb);
    const mail = require("./mail/mail")(mongodb);

    let app = express();
    app.use(function (req, res, next) {
        res.header("Access-Control-Allow-Origin", "http://10.0.0.247:8100");
        res.header('Access-Control-Allow-Credentials', true);
        next();
    });
    app.use(bodyParser.urlencoded({
        extended: true
    }));
    app.use("/cdn", express.static(path.join(__dirname + '/cdn')))

    app.get("/login", credentials.login);
    app.get("/signup", credentials.signup);
    app.get("/logout", credentials.logout);
    app.get("/getPlayers", teamProfile.getPlayers);
    app.get("/getHostedTeams", teamProfile.getHostedTeams);
    app.get("/getTeams", teamProfile.getTeams);
    app.get("/getGlobalTeams", teamProfile.getGlobalTeams);
    app.get("/getNextPlayers", teamProfile.getNextPlayers);
    app.get("/getAllRecipients", teamProfile.getAllRecipients);
    app.get("/chooseRole", teamProfile.chooseRole);
    app.get("/modifyEvent", teamProfile.modifyEvent);
    app.get("/getPresence", teamProfile.getPresence);
    app.get("/getAbsence", teamProfile.getAbsence);
    app.get("/getMaybe", teamProfile.getMaybe);
    app.get("/getPlayerInformation", teamProfile.getPlayerInformationQuery);
    app.get("/savePublicInfo", teamProfile.savePublicInfo);
    app.get("/getPublicInfo", teamProfile.getPublicInfo);
    app.get("/deleteEvents", teamProfile.deleteEvents);
    app.get("/getUserInformation", teamProfile.getUserInformationQuery);
    app.get("/getGeneralTeamInfo", teamProfile.getGeneralTeamInfo);
    app.get("/getUpcommingEvents", teamProfile.getUpcommingEvents);
    app.get("/changePresence", teamProfile.changePresence);
    app.get("/joinTeam", teamProfile.joinTeam);
    app.get("/createEvent", teamProfile.createEvent);
    app.get("/getNextEvents", teamProfile.getNextEvents);
    app.get("/createConversation", teamProfile.createConversation);
    app.get("/getConversations", teamProfile.getConversations);
    app.get("/getConversation", teamProfile.getConversation);
    app.get("/quitTeam", teamProfile.quitTeam);
    app.get("/excludeParticipant", teamProfile.excludeParticipant);
    app.get("/joinPending", teamProfile.joinPending);
    app.get("/generateNewInviteCode", teamProfile.generateNewInviteCode);
    app.get("/getPendingList", teamProfile.getPendingList);
    app.get("/acceptCoatchFromPendingList", teamProfile.acceptCoatchFromPendingList);
    app.get("/refuseCoatchFromPendingList", teamProfile.refuseCoatchFromPendingList);
    app.post("/newPlayer", teamProfile.createPlayer);
    app.post("/sendFile", teamProfile.sendFile);
    app.post("/newTeam", teamProfile.createTeam);
        

    // mail.sendEmail("reset");
    let server = app.listen(3000, console.log("listening on port 3000!"));
    const socket = require('./socket/socket')(server, mongodb);
});
